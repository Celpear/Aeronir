let exportData = null;

// Split ratio
const TRAIN_RATIO = 0.8;
const VALID_RATIO = 0.15;
const TEST_RATIO = 0.05;

async function loadExportData() {
    try {
        const res = await fetch('/api/export/yolo');
        exportData = await res.json();
        renderExport();
    } catch (err) {
        console.error(err);
        alert('Error loading export data');
    }
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function splitDataset(images) {
    const shuffled = shuffleArray(images);
    const total = shuffled.length;
    
    const trainEnd = Math.floor(total * TRAIN_RATIO);
    const validEnd = trainEnd + Math.floor(total * VALID_RATIO);
    
    return {
        train: shuffled.slice(0, trainEnd),
        valid: shuffled.slice(trainEnd, validEnd),
        test: shuffled.slice(validEnd)
    };
}

function renderExport() {
    if (!exportData) return;

    // Stats
    document.getElementById('stat-classes').textContent = exportData.classes.length;
    document.getElementById('stat-tiles').textContent = exportData.totalImages;
    document.getElementById('stat-boxes').textContent = exportData.totalBoxes;

    // Classes
    document.getElementById('classes-content').textContent = 
        exportData.classesFile || '(No classes defined)';

    // Images
    const tilesList = document.getElementById('tiles-list');
    tilesList.innerHTML = '';

    if (!exportData.images || exportData.images.length === 0) {
        tilesList.innerHTML = '<p class="no-data">No annotations available.</p>';
        return;
    }

    // Preview of split
    const split = splitDataset(exportData.images);
    
    const splitInfo = document.createElement('div');
    splitInfo.className = 'split-info';
    splitInfo.innerHTML = `
        <h3>ðŸ“Š Dataset Split (on export)</h3>
        <div class="split-stats">
            <div class="split-stat">
                <span class="split-label">Train</span>
                <span class="split-value">${split.train.length}</span>
                <span class="split-percent">${Math.round(split.train.length / exportData.images.length * 100)}%</span>
            </div>
            <div class="split-stat">
                <span class="split-label">Valid</span>
                <span class="split-value">${split.valid.length}</span>
                <span class="split-percent">${Math.round(split.valid.length / exportData.images.length * 100)}%</span>
            </div>
            <div class="split-stat">
                <span class="split-label">Test</span>
                <span class="split-value">${split.test.length}</span>
                <span class="split-percent">${Math.round(split.test.length / exportData.images.length * 100)}%</span>
            </div>
        </div>
    `;
    tilesList.appendChild(splitInfo);

    exportData.images.forEach(img => {
        const card = document.createElement('div');
        card.className = 'tile-card';
        
        const imageName = img.imagePath.split('/').pop();
        
        card.innerHTML = `
            <div class="tile-preview">
                <img src="${img.imagePath}" alt="Box ${img.boxId}" loading="lazy" />
                <div class="tile-overlay">
                    <span class="tile-coords">${img.gridSize} Tiles Â· ${img.imageSize.width}Ã—${img.imageSize.height}px</span>
                </div>
            </div>
            <div class="tile-info">
                <div class="tile-header">
                    <h4>${imageName.replace('.jpg', '.txt')}</h4>
                    <span class="annotation-count">Box #${img.boxId}</span>
                </div>
                <pre class="yolo-content">${img.yoloLine}</pre>
                <div class="tile-labels">
                    <span class="label-tag">${img.annotation.labelName}</span>
                </div>
                <div class="tile-actions">
                    <button class="small-btn" onclick="copyToClipboard('${escapeForJs(img.yoloLine)}')">
                        ðŸ“‹ Copy
                    </button>
                </div>
            </div>
        `;
        
        tilesList.appendChild(card);
    });
}

function escapeForJs(str) {
    return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text.replace(/\\n/g, '\n')).then(() => {
        showToast('Copied to clipboard!');
    });
}

function generateDataYaml(classes, datasetName = 'aerial_dataset') {
    return `# YOLO Dataset Configuration
# Generated by Aeronir on ${new Date().toISOString()}

path: .  # Dataset root directory
train: train/images  # Train images relative to 'path'
val: valid/images    # Validation images relative to 'path'
test: test/images    # Test images relative to 'path' (optional)

# Classes
nc: ${classes.length}  # Number of classes
names:
${classes.map((c, i) => `  ${i}: ${c.name}`).join('\n')}
`;
}

async function downloadAll() {
    if (!exportData || !exportData.images || exportData.images.length === 0) {
        alert('No data to export');
        return;
    }

    // Dynamically load JSZip
    if (typeof JSZip === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
    }

    showToast('Preparing YOLO dataset...');
    
    const zip = new JSZip();
    
    // Split dataset
    const split = splitDataset(exportData.images);
    
    // Create folder structure
    const trainImages = zip.folder('train/images');
    const trainLabels = zip.folder('train/labels');
    const validImages = zip.folder('valid/images');
    const validLabels = zip.folder('valid/labels');
    const testImages = zip.folder('test/images');
    const testLabels = zip.folder('test/labels');
    
    // Helper function to add images
    async function addImagesToSplit(images, imagesFolder, labelsFolder, splitName) {
        for (let i = 0; i < images.length; i++) {
            const img = images[i];
            const imageName = img.imagePath.split('/').pop();
            const txtName = imageName.replace('.jpg', '.txt');
            
            // Add annotation
            labelsFolder.file(txtName, img.yoloLine);
            
            // Download and add image
            try {
                const response = await fetch(img.imagePath);
                const blob = await response.blob();
                imagesFolder.file(imageName, blob);
            } catch (e) {
                console.error(`Error loading ${imageName}:`, e);
            }
            
            // Show progress
            const progress = Math.round(((i + 1) / images.length) * 100);
            showToast(`${splitName}: ${progress}% (${i + 1}/${images.length})`);
        }
    }
    
    // Add images to respective splits
    await addImagesToSplit(split.train, trainImages, trainLabels, 'Train');
    await addImagesToSplit(split.valid, validImages, validLabels, 'Valid');
    await addImagesToSplit(split.test, testImages, testLabels, 'Test');
    
    // Create data.yaml
    zip.file('data.yaml', generateDataYaml(exportData.classes));
    
    // classes.txt (optional, for compatibility)
    zip.file('classes.txt', exportData.classesFile);
    
    // README
    const readme = `# YOLO Dataset Export

Generated by Aeronir on ${new Date().toISOString()}

## Structure

\`\`\`
dataset/
â”œâ”€â”€ train/
â”‚   â”œâ”€â”€ images/     # ${split.train.length} images
â”‚   â””â”€â”€ labels/     # ${split.train.length} annotations
â”œâ”€â”€ valid/
â”‚   â”œâ”€â”€ images/     # ${split.valid.length} images
â”‚   â””â”€â”€ labels/     # ${split.valid.length} annotations
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ images/     # ${split.test.length} images
â”‚   â””â”€â”€ labels/     # ${split.test.length} annotations
â”œâ”€â”€ data.yaml       # YOLO configuration
â”œâ”€â”€ classes.txt     # Class names
â””â”€â”€ README.txt
\`\`\`

## Usage with YOLOv8

\`\`\`bash
# Start training
yolo detect train data=data.yaml model=yolov8n.pt epochs=100 imgsz=640

# Validation
yolo detect val data=data.yaml model=runs/detect/train/weights/best.pt

# Inference
yolo detect predict model=runs/detect/train/weights/best.pt source=path/to/images
\`\`\`

## Classes

${exportData.classes.map((c, i) => `${i}: ${c.name}`).join('\n')}

## Statistics

- Classes: ${exportData.classes.length}
- Total: ${exportData.totalImages} images
- Train: ${split.train.length} (${Math.round(TRAIN_RATIO * 100)}%)
- Valid: ${split.valid.length} (${Math.round(VALID_RATIO * 100)}%)
- Test: ${split.test.length} (${Math.round(TEST_RATIO * 100)}%)

## Notes

- All images use Sentinel-2 Cloudless satellite imagery from EOX
- Annotations are in YOLO format: class_id x_center y_center width height
- All coordinates are normalized (0-1)
`;
    zip.file('README.txt', readme);
    
    showToast('Creating ZIP file...');
    
    // Generate and download ZIP
    const blob = await zip.generateAsync({ 
        type: 'blob',
        compression: 'DEFLATE',
        compressionOptions: { level: 6 }
    });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `yolo_dataset_${Date.now()}.zip`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('YOLO dataset downloaded! âœ…');
}

function copyClasses() {
    if (!exportData) return;
    navigator.clipboard.writeText(exportData.classesFile).then(() => {
        showToast('classes.txt copied to clipboard!');
    });
}

function copyDataYaml() {
    if (!exportData) return;
    const yaml = generateDataYaml(exportData.classes);
    navigator.clipboard.writeText(yaml).then(() => {
        showToast('data.yaml copied to clipboard!');
    });
}

function showToast(message) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    loadExportData();
    
    document.getElementById('download-all').addEventListener('click', downloadAll);
    document.getElementById('copy-classes').addEventListener('click', copyClasses);
});
